# Como Saber se um Exploit Vai Funcionar ANTES de Executar

## O Conceito Central

Quando você escaneia uma vulnerabilidade com `scan_address()`, o jogo mostra os **requisitos** com asterisco (`*`). O
objeto **NetSession** tem métodos que retornam os valores atuais do alvo. **Comparando os dois, você sabe se vai
funcionar.**

---

## Os 4 Requisitos Possíveis

| Requisito no scan_address                | O que significa                    | Método para verificar          |
| ---------------------------------------- | ---------------------------------- | ------------------------------ |
| `* Checking an active user`              | Precisa de usuário não-root logado | `sessao.is_any_active_user()`  |
| `* Checking root active user`            | Precisa do root logado             | `sessao.is_root_active_user()` |
| `* Checking registered users equal to X` | Precisa de exatamente X usuários   | `sessao.get_num_users()`       |
| `* Checking forwarded ports equal to X`  | Precisa de X portas redirecionadas | `sessao.get_num_portforward()` |

**Se o requisito não aparecer**: não precisa verificar, o exploit não exige isso.

---

## Fluxo de Verificação Manual

```
1. Conectar ao alvo com net_use()
2. Escanear vulnerabilidades com scan() e scan_address()
3. Ler os requisitos (linhas com *)
4. Usar os métodos do NetSession para ver valores atuais
5. Comparar: valor atual atende ao requisito?
   → SIM: exploit vai funcionar
   → NÃO: exploit vai retornar null
```

---

## Exemplo Prático Passo a Passo

### Situação: Você quer hackear 85.217.43.92 na porta 22

**Passo 1: Conectar e obter a biblioteca**

```greyscript
meta = include_lib("/lib/metaxploit.so")
sessao = meta.net_use("85.217.43.92", 22)
lib = sessao.dump_lib
```

**Passo 2: Escanear vulnerabilidades**

```greyscript
enderecos = meta.scan(lib)
// Retorna: ["0x7A3F2E1D", "0x1B4C5D6E", ...]
```

**Passo 3: Ver detalhes de uma vulnerabilidade**

```greyscript
info = meta.scan_address(lib, "0x7A3F2E1D")
print(info)
```

**Saída exemplo:**

```
Unsafe check: conserti. Buffer overflow when comparing strings.
* Checking an active user
* Checking registered users equal to 2
```

**Passo 4: Verificar se o alvo atende**

```greyscript
print("Usuário ativo: " + sessao.is_any_active_user())      // Retorna 0 ou 1
print("Usuários registrados: " + sessao.get_num_users())    // Retorna número
```

**Saída:**

```
Usuário ativo: 0
Usuários registrados: 3
```

**Passo 5: Comparar**

| Requisito            | Precisa | Alvo tem | Resultado     |
| -------------------- | ------- | -------- | ------------- |
| active user          | 1       | 0        | ❌ NÃO ATENDE |
| registered users = 2 | 2       | 3        | ❌ NÃO ATENDE |

**Conclusão: Este exploit VAI FALHAR (retornar null)**

---

## Script Completo: Verificador de Exploits

Este script faz tudo automaticamente e te diz se vai funcionar:

```greyscript
// verificar_exploit.src
// Uso: verificar_exploit [IP] [PORTA]
// Exemplo: verificar_exploit 85.217.43.92 22

if params.len < 2 then
    exit("Uso: verificar_exploit [IP] [PORTA]")
end if

ip = params[0]
porta = params[1].to_int

// Carregar metaxploit
meta = include_lib("/lib/metaxploit.so")
if not meta then
    meta = include_lib(current_path + "/metaxploit.so")
end if
if not meta then
    exit("ERRO: metaxploit.so nao encontrado")
end if

// Conectar
print("[*] Conectando a " + ip + ":" + porta + "...")
sessao = meta.net_use(ip, porta)
if not sessao then
    exit("ERRO: Falha na conexao")
end if

lib = sessao.dump_lib
print("[+] Biblioteca: " + lib.lib_name + " v" + lib.version)
print("")

// COLETAR ESTADO ATUAL DO ALVO
print("="*50)
print("  ESTADO ATUAL DO ALVO")
print("="*50)
estado_usuario_ativo = sessao.is_any_active_user
estado_root_ativo = sessao.is_root_active_user
estado_num_usuarios = sessao.get_num_users
estado_num_portas = sessao.get_num_portforward

print("[+] Usuario ativo........: " + estado_usuario_ativo + " (1=sim, 0=nao)")
print("[+] Root ativo...........: " + estado_root_ativo + " (1=sim, 0=nao)")
print("[+] Usuarios registrados.: " + estado_num_usuarios)
print("[+] Portas redirecionadas: " + estado_num_portas)
print("")

// ESCANEAR VULNERABILIDADES
print("="*50)
print("  ANALISE DE VULNERABILIDADES")
print("="*50)
enderecos = meta.scan(lib)

if enderecos.len == 0 then
    exit("[-] Nenhuma vulnerabilidade encontrada")
end if

print("[+] Encontradas " + enderecos.len + " vulnerabilidades")
print("")

// ANALISAR CADA VULNERABILIDADE
exploits_vao_funcionar = []
exploits_vao_falhar = []

for addr in enderecos
    info = meta.scan_address(lib, addr)

    // Extrair valor vulneravel
    valor_vuln = "???"
    if info.indexOf("<b>") != null then
        inicio = info.indexOf("<b>") + 3
        fim = info.indexOf("</b>")
        if fim > inicio then
            valor_vuln = info[inicio:fim]
        end if
    end if

    // VERIFICAR CADA REQUISITO
    problemas = []

    // Requisito: active user
    if info.indexOf("Checking an active user") != null then
        if estado_usuario_ativo == 0 then
            problemas.push("Precisa usuario ativo (atual: 0)")
        end if
    end if

    // Requisito: root active
    if info.indexOf("Checking root active user") != null then
        if estado_root_ativo == 0 then
            problemas.push("Precisa root ativo (atual: 0)")
        end if
    end if

    // Requisito: registered users
    if info.indexOf("registered users equal to") != null then
        // Extrair o numero do requisito
        idx = info.indexOf("equal to ")
        if idx != null then
            resto = info[idx+9:]
            num_req = ""
            for c in resto.values
                if c >= "0" and c <= "9" then
                    num_req = num_req + c
                else
                    break
                end if
            end for
            if num_req != "" then
                num_necessario = num_req.to_int
                if estado_num_usuarios != num_necessario then
                    problemas.push("Precisa " + num_necessario + " usuarios (atual: " + estado_num_usuarios + ")")
                end if
            end if
        end if
    end if

    // Requisito: forwarded ports
    if info.indexOf("forwarded ports equal to") != null then
        idx = info.indexOf("equal to ")
        if idx != null then
            resto = info[idx+9:]
            num_req = ""
            for c in resto.values
                if c >= "0" and c <= "9" then
                    num_req = num_req + c
                else
                    break
                end if
            end for
            if num_req != "" then
                num_necessario = num_req.to_int
                if estado_num_portas != num_necessario then
                    problemas.push("Precisa " + num_necessario + " portas (atual: " + estado_num_portas + ")")
                end if
            end if
        end if
    end if

    // RESULTADO
    resultado = {
        "addr": addr,
        "valor": valor_vuln,
        "problemas": problemas
    }

    if problemas.len == 0 then
        exploits_vao_funcionar.push(resultado)
    else
        exploits_vao_falhar.push(resultado)
    end if
end for

// MOSTRAR RESULTADOS
print("")
print("="*50)
print("  EXPLOITS QUE VAO FUNCIONAR: " + exploits_vao_funcionar.len)
print("="*50)

if exploits_vao_funcionar.len == 0 then
    print("[-] Nenhum exploit vai funcionar com o estado atual")
else
    for e in exploits_vao_funcionar
        print("")
        print("[OK] " + e.addr)
        print("     Valor: " + e.valor)
        print("     Status: TODOS REQUISITOS ATENDIDOS")
    end for
end if

print("")
print("="*50)
print("  EXPLOITS QUE VAO FALHAR: " + exploits_vao_falhar.len)
print("="*50)

for e in exploits_vao_falhar
    print("")
    print("[X] " + e.addr)
    print("    Valor: " + e.valor)
    print("    Problemas:")
    for p in e.problemas
        print("      - " + p)
    end for
end for

// SUGESTOES
print("")
print("="*50)
print("  COMO RESOLVER")
print("="*50)

if estado_usuario_ativo == 0 then
    print("[!] Para ativar usuario: envie email com template 'Online user'")
end if

if estado_root_ativo == 0 then
    print("[!] Para ativar root: envie email com template 'Admin online'")
end if

print("[!] Usuarios registrados e portas NAO podem ser alterados")
print("[!] Se nenhum exploit funciona, tente outra porta ou roteador")

// PERGUNTAR SE QUER EXECUTAR
if exploits_vao_funcionar.len > 0 then
    print("")
    print("="*50)
    resposta = user_input("[?] Executar exploit que vai funcionar? (s/n): ")

    if resposta == "s" or resposta == "S" then
        e = exploits_vao_funcionar[0]
        print("[*] Executando " + e.addr + " com valor " + e.valor)

        resultado = lib.overflow(e.addr, e.valor)
        tipo = typeof(resultado)

        if tipo == "shell" then
            print("[+] SHELL OBTIDO!")
            resultado.start_terminal
        else if tipo == "computer" then
            print("[+] Acesso ao computador obtido")
        else if tipo == "file" then
            print("[+] Acesso a arquivo: " + resultado.path)
        else
            print("[-] Retornou: " + tipo)
        end if
    end if
end if
```

---

## Como Usar o Script

### 1. Criar o arquivo

```bash
touch /home/guest verificar_exploit.src
CodeEditor.exe /home/guest/verificar_exploit.src
```

### 2. Colar o código e salvar

### 3. Compilar

```bash
build /home/guest/verificar_exploit.src /home/guest
```

### 4. Executar

```bash
/home/guest/verificar_exploit 85.217.43.92 22
```

---

## Exemplo de Saída do Script

```
[*] Conectando a 85.217.43.92:22...
[+] Biblioteca: libssh.so v1.2.0

==================================================
  ESTADO ATUAL DO ALVO
==================================================
[+] Usuario ativo........: 0 (1=sim, 0=nao)
[+] Root ativo...........: 0 (1=sim, 0=nao)
[+] Usuarios registrados.: 3
[+] Portas redirecionadas: 2

==================================================
  EXPLOITS QUE VAO FUNCIONAR: 1
==================================================

[OK] 0x7B3C4D5E
     Valor: bl_treel
     Status: TODOS REQUISITOS ATENDIDOS

==================================================
  EXPLOITS QUE VAO FALHAR: 2
==================================================

[X] 0x1A2B3C4D
    Valor: conserti
    Problemas:
      - Precisa usuario ativo (atual: 0)
      - Precisa 2 usuarios (atual: 3)

[X] 0x9F8E7D6C
    Valor: unsafepwd
    Problemas:
      - Precisa root ativo (atual: 0)

==================================================
  COMO RESOLVER
==================================================
[!] Para ativar usuario: envie email com template 'Online user'
[!] Para ativar root: envie email com template 'Admin online'
[!] Usuarios registrados e portas NAO podem ser alterados

==================================================
[?] Executar exploit que vai funcionar? (s/n): s
[*] Executando 0x7B3C4D5E com valor bl_treel
[+] SHELL OBTIDO!
```

---

## Tabela de Referência: Requisitos e Soluções

| Se o problema é...      | Você pode resolver? | Como?                           |
| ----------------------- | ------------------- | ------------------------------- |
| `Precisa usuario ativo` | ✅ SIM              | Email template "Online user"    |
| `Precisa root ativo`    | ✅ SIM              | Email template "Admin online"   |
| `Precisa X usuarios`    | ❌ NÃO              | Tente outro exploit             |
| `Precisa X portas`      | ❌ NÃO              | Tente outro exploit ou roteador |

---

## Resumo Final

1. **scan_address()** mostra os requisitos (linhas com `*`)
2. **NetSession** tem métodos para verificar estado atual:
   - `is_any_active_user()`
   - `is_root_active_user()`
   - `get_num_users()`
   - `get_num_portforward()`
3. **Compare** requisito vs estado atual
4. **Se bater** = exploit funciona
5. **Se não bater** = exploit retorna null

**O script acima faz tudo isso automaticamente!**
